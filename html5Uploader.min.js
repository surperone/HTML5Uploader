var Uploader=function(){function a(d){if(!(this instanceof a))return new a(d);if(!window.FormData)throw new Error("浏览器不支持");b(d)&&(d={trigger:d}),d||(d={}),d.multiple=!1;var e={trigger:null,name:null,action:null,data:null,change:null,error:null,success:null,progress:null,preprocess:null};d&&$.extend(e,d);var f=$(e.trigger);e.action=e.action||f.data("action")||location.href,e.name=e.name||f.attr("name")||f.data("name")||"file",e.data=e.data||c(f.data("data")),e.accept=e.accept||f.data("accept"),e.success=e.success||f.data("success"),this.settings=e,this.setup()}function b(a){return"[object String]"===Object.prototype.toString.call(a)}function c(a){if(!a)return{};for(var b={},c=a.split("&"),d=function(a){return decodeURIComponent(a.replace(/\+/g," "))},e=0;e<c.length;e++){var f=c[e].split("="),g=d(f[0]);b[g]=d(f[1])}return b}function d(c){if(!(this instanceof d))return new d(c);b(c)&&(c={trigger:c});var e=$(c.trigger),f=[];e.each(function(b,d){c.trigger=d,f.push(new a(c))}),this._uploaders=f}return a.prototype.setup=function(){var a=this,b=this.getTrigger();return b.on("change",function(c){var d=this.files;if(d&&d.length>0&&""!=d[0].name){a._files=this.files||[{name:c.target.value}];var e=b.val();a.settings.change?a.settings.change.call(a,a._files):e&&a.submit()}}),this},a.prototype.submit=function(){if(this._files.length<1)return this;if(this.settings.preprocess){var a=this,b=function(b){a._upload(b)},c=function(){a._upload(a._files)};this.settings.preprocess.call(this,a._files,b,c)}else this._upload(this._files);return this},a.prototype._upload=function(a){var b=this,c=new FormData,d=this.settings.data;d=$.isFunction(d)?d.call(this,a):d,$.each(d||{},function(a,b){c.append(a,b)}),this.settings.multiple?$.each(a,function(a,d){var e=b.settings.name+"["+a+"]";c.append(e,d)}):c.append(this.settings.name,a[0]);var e;b.settings.progress&&(e=function(){var c=$.ajaxSettings.xhr();return c.upload&&c.upload.addEventListener("progress",function(c){var d=0,e=c.loaded||c.position,f=c.total;c.lengthComputable&&(d=Math.ceil(e/f*100)),b.settings.progress.call(b,c,e,f,d,a)},!1),c});var f=this.settings.success||$.noop,g=this.settings.error||$.noop;return $.ajax({url:this.settings.action,type:"post",dataType:"json",processData:!1,contentType:!1,multiple:!1,data:c,xhr:e,context:this,success:f.bind(this),error:g.bind(this)}),this},a.prototype.setData=function(a,b){this.settings.data||(this.settings.data={}),this.settings.data[a]=b},a.prototype.getTrigger=function(){return $(this.settings.trigger)},a.prototype.change=function(a){return a&&(this.settings.change=a),this},a.prototype.success=function(a){return a&&(this.settings.success=a),this},a.prototype.error=function(a){return a&&(this.settings.error=a),this},a.prototype.progress=function(a){return a&&(this.settings.progress=a),this},a.prototype.preprocess=function(a){return a&&(this.settings.preprocess=a),this},a.prototype.enable=function(){this.getTrigger().prop("disabled",!1)},a.prototype.disable=function(){this.getTrigger().prop("disabled",!0)},d.prototype.submit=function(){return $.each(this._uploaders,function(a,b){b.submit()}),this},d.prototype.change=function(a){return $.each(this._uploaders,function(b,c){c.change(a)}),this},d.prototype.success=function(a){return $.each(this._uploaders,function(b,c){c.success(a)}),this},d.prototype.error=function(a){return $.each(this._uploaders,function(b,c){c.error(a)}),this},d.prototype.progress=function(a){return $.each(this._uploaders,function(b,c){c.progress(a)}),this},d.prototype.preprocess=function(a){return $.each(this._uploaders,function(b,c){c.preprocess(a)}),this},d.prototype.enable=function(){return $.each(this._uploaders,function(a,b){b.enable()}),this},d.prototype.disable=function(){return $.each(this._uploaders,function(a,b){b.disable()}),this},d.isSupport=function(){return!!window.FormData},d.Uploader=a,d}();